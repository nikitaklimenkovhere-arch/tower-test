<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tower Bloxx — Matter.js</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:linear-gradient(#87ceeb,#e0f6ff);font-family:sans-serif}
  canvas{display:block}
  #hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.85);padding:6px 12px;border-radius:10px;font-weight:700;z-index:2}
  #msg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:42px;font-weight:900;text-shadow:0 2px 6px rgba(0,0,0,.6);opacity:0;transition:.25s;z-index:2}
  #restart{position:fixed;top:62%;left:50%;transform:translateX(-50%);display:none;border:none;background:#ff4b77;color:#fff;padding:10px 18px;border-radius:10px;font-size:18px;z-index:2}
</style>
</head>
<body>
<canvas id="cv"></canvas>
<div id="hud">Очки: 0 | Рекорд: 0</div>
<div id="msg"></div>
<button id="restart">Заново</button>

<script>
/*! Matter.js 0.19.0 — минифицированная версия */
!function(e,t){"object"==typeof module&&"object"==typeof module.exports?module.exports=t():e.Matter=t()}(this,function(){/* ... Здесь будет минифицированный код matter.min.js ... */});
</script>

<script>
// ========== НАСТРОЙКИ ==========
const BW = 80, BH = 40;
const W = window.innerWidth, H = window.innerHeight;
let score=0, best=+localStorage.getItem('tb_best')||0;

// ========== Matter.js ==========
const {Engine,Render,Runner,World,Bodies,Body,Events,Composite} = Matter;

const engine = Engine.create();
const world = engine.world;

// Рендер на нашем canvas
const render = Render.create({
  canvas: document.getElementById('cv'),
  engine: engine,
  options: {
    width: W,
    height: H,
    wireframes: false,
    background: 'transparent'
  }
});
Render.run(render);
const runner = Runner.create();
Runner.run(runner, engine);

// Пол
const ground = Bodies.rectangle(W/2, H+50, W, 100, { isStatic: true });
World.add(world, ground);

// Начальная башня (1 блок)
let blocks = [];
const baseBlock = Bodies.rectangle(W/2, H-BH/2, BW, BH, { restitution:0.05, friction:0.8 });
blocks.push(baseBlock);
World.add(world, baseBlock);

let currentBlock = null;
let swingAngle = 0;
let swingSpeed = 0.02;
let amp = W/3;
let mode = 'swing';

// Создание нового блока над башней
function newBlock(){
  currentBlock = Bodies.rectangle(W/2, 100, BW, BH, { restitution:0.05, friction:0.8 });
  Body.setStatic(currentBlock, true); // пока висит
  World.add(world, currentBlock);
}
newBlock();

// Сброс блока
function drop(){
  if(mode!=='swing') return;
  const ropeX = W/2 + Math.sin(swingAngle)*amp;
  Body.setPosition(currentBlock, {x: ropeX, y: currentBlock.position.y});
  Body.setVelocity(currentBlock, {x: Math.cos(swingAngle)*amp*swingSpeed, y: 0});
  Body.setStatic(currentBlock, false);
  mode = 'drop';
}

// Логика игры
Events.on(engine, 'beforeUpdate', ()=>{
  if(mode==='swing'){
    swingAngle += swingSpeed;
    const ropeX = W/2 + Math.sin(swingAngle)*amp;
    Body.setPosition(currentBlock, {x: ropeX, y: currentBlock.position.y});
  }
  if(mode==='drop'){
    if(currentBlock.position.y > H - BH - 50){
      score++;
      if(score>best){ best=score; localStorage.setItem('tb_best',best);}
      blocks.push(currentBlock);
      newBlock();
      mode='swing';
    }
  }
});

// HUD
function hudUpdate(){
  document.getElementById('hud').textContent = `Очки: ${score} | Рекорд: ${best}`;
  requestAnimationFrame(hudUpdate);
}
hudUpdate();

// Ввод
document.getElementById('cv').addEventListener('click', drop);
document.getElementById('cv').addEventListener('touchstart', e=>{e.preventDefault(); drop();},{passive:false});
document.getElementById('restart').addEventListener('click', ()=>{
  location.reload();
});
</script>
</body>
</html>
